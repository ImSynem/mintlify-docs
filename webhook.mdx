---
title: 'Webhook'
description: 'Receive POST requests to your URL automatically when an event occurs.'
---

Merchants can set up a `callbackUrl` in their merchant requests, and upon processing payments, CashPay will send you notifications in JSON format with all required information about the transaction, such as the amount and status, when the payment status is changed to Waiting, Confirming, Paid, Failed, or Expired.

To receive webhook notifications, first, you should implement a standard HTTP POST (application/json) call over an HTTPS URL to a CGI script on your server. Insert your created endpoint address in the `callbackUrl` field of merchant requests. You will receive payment updates (statuses) to this URL address.

However, you will initially receive a callback with the "Confirming" status. You should wait for a second callback where the "status" value will be "Paid". When we confirm the transaction, we are ready to manage all the risks concerning accepting real funds later. You should not be concerned about it.

Merchant's callbackUrl must return an HTTP Response 200 with content: ok for CashPay API to confirm the callback as successful. The system will try to deliver a webhook notification up to 5 times or until a successful delivery occurs, whichever happens first. If the first attempt fails, the second one is triggered after approximately 1 minute. The third one is delayed for 3 more minutes, the fourth for 30 minutes, and the last one for 3 hours.

The payout webhook is similar to a merchant webhook exactly. But for withdrawals, you will receive different values of the "address" parameter in every callback.

### Validating Callbacks

Merchants must validate the signature of callbacks coming from CashPay using either their `Webhook Secret Key` if the webhook was set up in the dashboard, or an `API Key`associated with the account if webhook is from `callbackUrl`. also for payout webhooks you must validate the signature using your `PAYOUT_API_KEY`. CashPay uses your `MERCHANT_API_KEY` as the HMAC shared secret key to generate an HMAC(sha512) signature of the raw POST data. The HMAC signature is sent as an HTTP header called `HMAC`. The body of the request contains the callback data in JSON format, similar to the Payment Information API response body.

### Testing Webhook

For payment callback handling, you can use tools like requestcatcher.com to create a test `callbackUrl` and inspect the callback data sent from CashPay. Note that CashPay payment callbacks will not be sent to private networks (e.g., localhost).

For local debugging, you can use services like https://ngrok.io to expose your local server to the internet and receive webhook callbacks.

**To utilize the payment webhook, please follow these steps:**

1. Create a web server and define an endpoint to handle POST requests.

   - Ensure that the firewall software on your server (e.g., Cloudflare) allows incoming requests from CashPay. You may need to whitelist CashPay's IP addresses on your side. Please reach out to support@cashpay.space to obtain the list of IP addresses.

2. Configure your server to receive POST requests at the specified endpoint URL.

   - The POST request body will contain the necessary parameters sent by CashPay in JSON format.

3. Validate the HMAC signature of the request to ensure the authenticity of the callback.

   - Use your `MERCHANT_API_KEY` to calculate the HMAC signature and compare it with the received HMAC header.

4. Process the callback data accordingly based on the status and other parameters provided.

### Sample Payment IPN data

In this section, we will provide examples of the data CashPay send to your system at various stages of the payment process.

<CodeGroup>

```json Payment Created
{
  "eventType": "PAYMENT_CREATED",
  "id": "cm2m00tok2221w6pp7mmabhn7",
  "userId": "cm1av4q2l60002638vzvdzweu",
  "cashTag": "$Example",
  "note": "example-note",
  "amount": 11.11,
  "isWhiteLabel": false,
  "receiptId": null,
  "paidAmount": null,
  "cashpayFee": null,
  "status": "PENDING",
  "callbackUrl": "https://your-callback-url.com/callback",
  "returnUrl": "https://your-return-url.com",
  "expiresAt": "2024-10-24T14:57:49.123Z",
  "createdAt": "2024-10-23T14:57:49.124Z",
  "updatedAt": "2024-10-23T14:57:49.124Z"
}
```

```json Payment Completed
{
  "eventType": "PAYMENT_COMPLETED",
  "id": "cm2m00tok2221w6pp7mmabhn7",
  "userId": "cm1av4q2l60002638vzvdzweu",
  "cashTag": "$Example",
  "note": "example-note",
  "amount": 11.11,
  "isWhiteLabel": false,
  "receiptId": "c6onh81g30c1aw37bz89nuwgt",
  "paidAmount": null,
  "cashpayFee": 0.17,
  "status": "PAID",
  "callbackUrl": "https://your-callback-url.com/callback",
  "returnUrl": "https://your-return-url.com",
  "expiresAt": "2024-10-24T14:57:49.123Z",
  "createdAt": "2024-10-23T14:57:49.124Z",
  "updatedAt": "2024-10-23T15:17:14.559Z"
}
```

```json Payment Expired
{
  "eventType": "PAYMENT_EXPIRED",
  "id": "cm2m00tok2221w6pp7mmabhn7",
  "userId": "cm1av4q2l60002638vzvdzweu",
  "cashTag": "$Example",
  "note": "example-note",
  "amount": 11.11,
  "isWhiteLabel": false,
  "receiptId": null,
  "paidAmount": null,
  "cashpayFee": null,
  "status": "EXPIRED",
  "callbackUrl": "https://your-callback-url.com/callback",
  "returnUrl": "https://your-return-url.com",
  "expiresAt": "2024-10-24T14:57:49.123Z",
  "createdAt": "2024-10-23T14:57:49.124Z",
  "updatedAt": "2024-10-23T14:57:49.124Z"
}
```

```json Payment Failed
{
  "eventType": "PAYMENT_FAILED",
  "id": "cm2m00tok2221w6pp7mmabhn7",
  "userId": "cm1av4q2l60002638vzvdzweu",
  "cashTag": "$Example",
  "note": "example-note",
  "amount": 11.11,
  "isWhiteLabel": false,
  "receiptId": "c6onh81g30c1aw37bz89nuwgt",
  "paidAmount": null,
  "cashpayFee": null,
  "status": "FAILED",
  "callbackUrl": "https://your-callback-url.com/callback",
  "returnUrl": "https://your-return-url.com",
  "expiresAt": "2024-10-24T14:57:49.123Z",
  "createdAt": "2024-10-23T14:57:49.124Z",
  "updatedAt": "2024-10-23T14:57:49.124Z"
}
```

</CodeGroup>

### Example codes

<CodeGroup>

```php PHP
<?php
// Get the request data
$postData = file_get_contents('php://input');
$data = json_decode($postData, true);

$hmacHeader = $_SERVER['HTTP_HMAC'];
$calculatedHmac = hash_hmac('sha512', $postData, 'YOUR_WEBHOOK_SECRET_KEY');

if ($calculatedHmac === $hmacHeader) {
    // HMAC signature is valid
    // Process the callback data
    if ($data['eventType'] === 'PAYMENT_CREATED') {
        echo 'Received payment callback: ' . json_encode($data);
        // Process payment data here
    } elseif ($data['eventType'] === 'PAYMENT_COMPLETED') {
        echo 'Received payment callback: ' . json_encode($data);
        // Process payment data here
    }

    // Return HTTP Response 200 with content "OK"
    http_response_code(200);
    echo 'OK';
} else {
    // HMAC signature is not valid
    // Handle the error accordingly
    http_response_code(400);
    echo 'Invalid HMAC signature';
}
?>
```

```javascript Node.js
const http = require('http');
const crypto = require('crypto');

const server = http.createServer((req, res) => {
    if (req.url === '/callback' && req.method === 'POST') {
        // Validate HMAC signature
        let postData = '';

        req.on('data', chunk => {
            postData += chunk;
        });

        req.on('end', () => {
            // Parse the JSON data
            let data = null;
            try {
                data = JSON.parse(postData);
            } catch (error) {
                res.statusCode = 400;
                res.end('Invalid JSON data');
                return;
            }

            const hmacHeader = req.headers['hmac'];
            const calculatedHmac = crypto
                .createHmac('sha512', 'YOUR_WEBHOOK_SECRET_KEY')
                .update(postData)
                .digest('hex');

            if (calculatedHmac === hmacHeader) {
                // HMAC signature is valid
                // Process the callback data based on the type
                if (data.type === 'payment') {
                    console.log('Received payment callback:', data);
                    // Process payment data here
                } else if (data.type === 'payout') {
                    console.log('Received payout callback:', data);
                    // Process payout data here
                }

                // Return HTTP Response 200 with content "OK"
                res.statusCode = 200;
                res.end('OK');
            } else {
                // HMAC signature is not valid
                // Handle the error accordingly
                res.statusCode = 400;
                res.end('Invalid HMAC signature');
            }
        });
    } else {
        // Invalid path or method
        res.statusCode = 404;
        res.end('Not Found');
    }
});

server.listen(3000, () => {
    console.log('Server listening on port 3000');
});
```

```python Python
from flask import Flask, request
import hmac
import hashlib
import json

app = Flask(__name__)

@app.route('/callback', methods=['POST'])
def handle_callback():
    post_data = request.get_data(as_text=True)
    data = json.loads(post_data)

    # Validate HMAC signature
    api_secret_key = 'YOUR_WEBHOOK_SECRET_KEY'
    hmac_header = request.headers.get('HMAC')
    post_data = request.get_data()
    calculated_hmac = hmac.new(api_secret_key.encode(), post_data, hashlib.sha512).hexdigest()

    if calculated_hmac == hmac_header:
        # HMAC signature is valid
        # Process the callback data
        if data['eventType'] == 'PAYMENT_CREATED':
            print('Received payment callback:', data)
            # Process payment data here
        elif data['eventType'] == 'PAYMENT_COMPLETED':
            print('Received payment callback:', data)
            # Process payment data here
            # Return HTTP Response 200 with content "OK"
        return 'OK', 200
    else:
        # HMAC signature is not valid
        # Handle the error accordingly
        return 'Invalid HMAC signature', 400


if __name__ == '__main__':
    app.run(host='YOUR_HOST_ADDRESS',port=3000)
```



</CodeGroup>

Again, please note that these code snippets serve as examples and may require modifications based on your specific implementation and framework.

## Troubleshooting

Here are some common issues you might encounter when implementing webhooks and how to solve them:

<AccordionGroup>
  <Accordion title="Not receiving webhook notifications">
    - Ensure your `callbackUrl` is correctly set and accessible from the internet.
    - Check your server's firewall settings to allow incoming requests from CashPay.
    - Verify that your server is responding with a 200 OK status and 'ok' message.
  </Accordion>
  <Accordion title="Invalid HMAC signature">
    - Double-check that you're using the correct `MERCHANT_API_KEY` or `PAYOUT_API_KEY`.
    - Ensure you're calculating the HMAC signature on the raw POST data, not the parsed JSON.
    - Verify that you're using the SHA-512 algorithm for HMAC calculation.
  </Accordion>
  <Accordion title="Webhook timeouts">
    - Optimize your webhook handling code to process requests quickly.
    - Implement asynchronous processing for time-consuming tasks.
    - Ensure your server can handle concurrent webhook requests.
  </Accordion>
  <Accordion title="Duplicate webhook notifications">
    - Implement idempotency in your webhook handler to safely process duplicate notifications.
    - Store processed webhook IDs to detect and ignore duplicates.
  </Accordion>
</AccordionGroup>

If you're still experiencing issues after trying these solutions, please contact our support team at support@cashpay.space for further assistance.